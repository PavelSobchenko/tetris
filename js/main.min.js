var app=app||{};!function(){app.const={WIDTH:216,HEIGHT:280,CELL:8,SPEED_START:5,SPEED_MAX:45,SPEED_STEP:10,SIZE_FIGURE:4,STROKE_STYLE:"#3b6cba",FILL_STYLE:"#1464e5"},app.const.ROW_WIDTH=app.const.WIDTH/app.const.CELL}();var app=app||{};!function(){"use strict";app.classes=app.classes||{},app.classes.helper={getRandomInt:function(t,e){return Math.floor(Math.random()*(e-t+1))+t}}}();var app=app||{};!function(){"use strict";app.CellModel=Backbone.Model.extend({defaults:{x:0,y:0,left:!1,right:!1,center:!1}})}();var app=app||{};!function(){"use strict";app.FigureCollection=Backbone.Collection.extend({model:app.CellModel,initialize:function(){},createFigure:function(t){var e=app.const.CELL,i=app.const.WIDTH/2-e/2;this.currentState=0;var n=[[{x:i-2*e,y:0-e,left:!0},{x:i-e,y:0-e},{x:i,y:0-e,center:!0},{x:i+e,y:0-e,right:!0}],[{x:i-e,y:0-e,left:!0},{x:i,y:0-e,right:!0},{x:i-e,y:0,left:!0},{x:i,y:0,right:!0}],[{x:i,y:-(2*e),left:!0},{x:i,y:-e,left:!0,center:!0},{x:i,y:0,left:!0},{x:i+e,y:0,right:!0}],[{x:i,y:0-e,right:!0,left:!0},{x:i-e,y:0-2*e,left:!0},{x:i,y:0-2*e,center:!0},{x:i+e,y:0-2*e,right:!0}],[{x:i-e,y:0-2*e,left:!0},{x:i,y:0-2*e,right:!0,center:!0},{x:i,y:0-e,left:!0},{x:i+e,y:0-e,right:!0}]],s=["I","C","L","T","Z"];this.type=s[t],this.reset(n[t])},rotateFigure:function(){},getNewArr:function(){this.currentState>3&&(this.currentState=0);var t={I:[[[2,-2],[1,-1],null,[-1,1]],[[-2,2],[-1,1],null,[1,-1]],[[2,-2],[1,-1],null,[-1,1]],[[-2,2],[-1,1],null,[1,-1]]],L:[[[1,1],null,[-1,-1],[-2,0]],[[-1,1],null,[1,-1],[0,-2]],[[-1,-1],null,[1,1],[2,0]],[[1,-1],null,[-1,1],[0,2]]],T:[["1",[1,-1],null,"0"],["1",[1,1],null,"0"],["1",[-1,1],null,"0"],["1",[-1,-1],null,"0"]],Z:[[[1,-1],null,"0",[-2,0]],[[-1,1],null,[1,1],[2,0]],[[1,-1],null,"0",[-2,0]],[[-1,1],null,[1,1],[2,0]]]},e={I:[[["left","right"],["left","right"],["left","right","center"],["left","right"]],[["left"],null,["center"],["right"]],[["left","right"],["left","right"],["left","right","center"],["left","right"]],[["left"],null,["center"],["right"]]],L:[[["right"],["center"],["left"],["left","right"]],[["left","right"],["left","right","center"],["right"],["left"]],[["left"],["center"],["right"],["left","right"]],[["left","right"],["left","right","center"],["left"],["right"]]],T:[[["left"],["left","right"],["center","right"],["left","right"]],[["left","right"],["right"],["center"],["left"]],[["right"],["left","right"],["left","center"],["left","right"]],[["left","right"],["left"],["center"],["right"]]],Z:[[["left","right"],["center","right"],["left"],["left","right"]],[["left"],["center","right"],["left"],["right"]],[["left","right"],["center","right"],["left"],["left","right"]],[["left"],["center","right"],["left"],["right"]]]},i=t[this.type][this.currentState],n=e[this.type][this.currentState],s=[],r=app.const.CELL;return this.each(function(t,e){var h={};i[e]?_.isString(i[e])?(h.x=this.at(i[e]).get("x"),h.y=this.at(i[e]).get("y")):(h.x=t.get("x")+i[e][0]*r,h.y=t.get("y")+i[e][1]*r):(h.x=t.get("x"),h.y=t.get("y")),n[e]&&_.each(n[e],function(t){h[t]=!0}),s.push(h)}.bind(this)),s},rotateSuccess:function(){++this.currentState},getCustom:function(){return{type:this.type,currentState:this.currentState}},setCustom:function(t){this.type=t.type,this.currentState=t.currentState}})}();var app=app||{};!function(){"use strict";app.CanvasView=Backbone.View.extend({el:"#cnvs",initialize:function(){this.el.style.border="1px solid #333",this.el.height=app.const.HEIGHT,this.el.width=app.const.WIDTH,this.ctx=this.el.getContext("2d"),this.setCtx(),this.speed=app.const.SPEED_START,this.cellRect=app.const.CELL,this.statePlaying=null,this.blockMoveDown=!1,this.CC=new app.FigureCollection,this.FC=new app.FigureCollection,app.eventDispatcher.on("startPlay",this.startLoop,this),$(window).on("keyup",this.keyUpController.bind(this)),$(window).on("keydown",this.keyDownController.bind(this))},render:function(){this.statePlaying&&(this.moveFigure(),this.draw(),this.check())},setCtx:function(t){t?(this.ctx.fillStyle=t.fill_style||app.const.FILL_STYLE,this.ctx.strokeStyle=t.stroke_style||app.const.STROKE_STYLE):(this.ctx.fillStyle=app.const.FILL_STYLE,this.ctx.strokeStyle=app.const.STROKE_STYLE)},keyDownController:function(t){this.statePlaying&&40==t.keyCode&&this.speed<app.const.SPEED_MAX&&(this.speed+=app.const.SPEED_STEP,this.play())},keyUpController:function(t){if(this.statePlaying){var e=t.ctrlKey;e&&(81==t.keyCode&&(this.endLoop(),this.startLoop()),88==t.keyCode&&this.gameOver()),40==t.keyCode&&(this.speed=app.const.SPEED_START,this.play()),37==t.keyCode&&(this.blockMoveDown=!0,this.moveFigure("left"),this.blockMoveDown=!1),39==t.keyCode&&(this.blockMoveDown=!0,this.moveFigure("right"),this.blockMoveDown=!1),38==t.keyCode&&this.checkRotate()&&console.log("rotate")}},gameOver:function(){this.stop(),this.statePlaying=null,app.eventDispatcher.trigger("gameover"),console.log("gameover")},checkLeft:function(t){var e=t.where({left:!0}),i=!0;return _.each(e,function(t){var e=this.FC.findWhere({x:t.get("x")-this.cellRect,y:t.get("y")});if(t.get("x")<=0||e)return i=!1,!0}.bind(this)),i},checkRight:function(t){var e=t.where({right:!0}),i=!0;return _.each(e,function(t){var e=this.FC.findWhere({x:t.get("x")+this.cellRect,y:t.get("y")});if(t.get("x")+this.cellRect>=app.const.WIDTH||e)return i=!1,!0}.bind(this)),i},check:function(){var t=!0;return this.CC.find(function(e){if(e.get("y")+this.cellRect==app.const.HEIGHT)return t=!1,e}.bind(this)),t?(this.CC.find(function(e){var i=e.get("x"),n=e.get("y")+this.cellRect;if(this.FC.findWhere({x:i,y:n}))return t=!1,e}.bind(this)),void(t||(this.endLoop(),this.CC.findWhere({y:0})?this.gameOver():this.startLoop()))):(this.endLoop(),void this.startLoop())},checkFillRow:function(){var t=this.FC.groupBy("y");_.each(t,function(t,e){t.length===app.const.ROW_WIDTH}.bind(this))},checkRotate:function(){if(1==this.CC.type)return!1;var t=new app.FigureCollection;if(t.add(this.CC.getNewArr()),this.checkLeft(t)&&this.checkRight(t)){var e=t.find(function(t){if(t.get("y")+this.cellRect>=app.const.HEIGHT)return t}.bind(this));if(e)return;this.CC.rotateSuccess(),t.setCustom(this.CC.getCustom()),this.CC=t}},startLoop:function(){this.CC.createFigure(2),this.play()},endLoop:function(){this.CC.each(function(t){this.FC.add(t)}.bind(this)),this.checkFillRow()},moveFigure:function(t){"left"==t?this.checkLeft(this.CC)?this.CC.each(function(t){t.set("x",t.get("x")-this.cellRect)}.bind(this)):this.blockMoveDown=!1:"right"==t?this.checkRight(this.CC)?this.CC.each(function(t){t.set("x",t.get("x")+this.cellRect)}.bind(this)):this.blockMoveDown=!1:this.blockMoveDown||this.CC.each(function(t){t.set("y",t.get("y")+this.cellRect)}.bind(this))},play:function(){this.playId&&this.stop(),this.playId=setInterval(this.render.bind(this),1e3/this.speed),this.statePlaying="play"},stop:function(){clearInterval(this.playId)},draw:function(){this.clear(),this.drawFigures()},drawFigures:function(){this.CC.each(this.drawCell,this),this.FC.each(this.drawCell,this)},drawCell:function(t){var e=t.get("x"),i=t.get("y");this.ctx.strokeRect(e,i,this.cellRect-.5,this.cellRect-.5),this.ctx.fillRect(e,i,this.cellRect-2,this.cellRect-2)},removeFillRow:function(t){var e=this.FC.where({y:parseInt(t)});console.log(e)},clear:function(){this.ctx.clearRect(0,0,app.const.WIDTH,app.const.HEIGHT)}})}();var app=app||{};!function(){"use strict";var t=Backbone.View.extend({el:"#page",initialize:function(){app.views={},app.models={},app.collections={},app.eventDispatcher=_.extend({},Backbone.Events),app.views.canvas=new app.CanvasView,this.startPlay()},startPlay:function(){app.eventDispatcher.trigger("startPlay")}});$(document).ready(function(){app.page=new t})}();
//# sourceMappingURL=main.min.js.map
