var app=app||{};!function(){app.const={WIDTH:240,HEIGHT:304,CELL:16,SPEED_START:5,SPEED_MAX:45,SPEED_STEP:10,SIZE_FIGURE:4,STROKE_STYLE:"#000",FILL_STYLE:"#333",REMOVE_CELL_ANIMATION_TIME:50,END_LOOP:10,REMOVE_ROW:100,GAME_OVER_FILL:"rgba(11, 1, 28, 0.85)",FIGURE_COLORS:{I:["#1464e5","#3b6cba"],C:["#fc2d2d","#bf1616"],L:["#f9921b","#e87f06"],RL:["#e9fc1b","#d5e80d"],T:["#6aed1e","#5bd813"],Z:["#3afca8","#20d888"],RZ:["#853ff4","#6015d8"]},SCORE_SIZE_ROW:5};var t=app.const.CELL,e=app.const.WIDTH/2-t/2,i=2*t,s=3*t,n=4*t,r=t/2;app.const.ROW_WIDTH=app.const.WIDTH/t,app.const.FIGURE=[[{x:e-2*t,y:-t,left:!0},{x:e-t,y:-t},{x:e,y:-t,center:!0},{x:e+t,y:-t,right:!0}],[{x:e-t,y:-(2*t),left:!0},{x:e,y:-(2*t),right:!0},{x:e-t,y:-t,left:!0},{x:e,y:-t,right:!0}],[{x:e,y:-(3*t),left:!0,right:!0},{x:e,y:-(2*t),left:!0,right:!0,center:!0},{x:e,y:-t,left:!0},{x:e+t,y:-t,right:!0}],[{x:e,y:-(3*t),left:!0,right:!0},{x:e,y:-(2*t),left:!0,right:!0,center:!0},{x:e,y:-t,right:!0},{x:e-t,y:-t,left:!0}],[{x:e,y:0-t,right:!0,left:!0},{x:e-t,y:-(2*t),left:!0},{x:e,y:0-2*t,center:!0},{x:e+t,y:-(2*t),right:!0}],[{x:e-t,y:0-2*t,left:!0},{x:e,y:0-2*t,right:!0,center:!0},{x:e,y:0-t,left:!0},{x:e+t,y:0-t,right:!0}],[{x:e+t,y:0-2*t,right:!0},{x:e,y:0-2*t,center:!0,left:!0},{x:e,y:0-t,right:!0},{x:e-t,y:0-t,left:!0}]],app.const.TYPE_MAP=["I","C","L","RL","T","Z","RZ"],app.const.TRANSFORM_MAP={I:[[[2,-2],[1,-1],null,[-1,1]],[[-2,2],[-1,1],null,[1,-1]],[[2,-2],[1,-1],null,[-1,1]],[[-2,2],[-1,1],null,[1,-1]]],L:[[[1,1],null,[-1,-1],[-2,0]],[[-1,1],null,[1,-1],[0,-2]],[[-1,-1],null,[1,1],[2,0]],[[1,-1],null,[-1,1],[0,2]]],RL:[[[1,1],null,[-1,-1],[0,-2]],[[-1,1],null,[1,-1],[2,0]],[[-1,-1],null,[1,1],[0,2]],[[1,-1],null,[-1,1],[-2,0]]],T:[["1",[1,-1],null,"0"],["1",[1,1],null,"0"],["1",[-1,1],null,"0"],["1",[-1,-1],null,"0"]],Z:[[[1,-1],null,"0",[-2,0]],[[-1,1],null,[1,1],[2,0]],[[1,-1],null,"0",[-2,0]],[[-1,1],null,[1,1],[2,0]]],RZ:[["2",null,[-1,-1],[0,-2]],[[1,-1],null,"0",[0,2]],["2",null,[-1,-1],[0,-2]],[[1,-1],null,"0",[0,2]]]},app.const.POSITION_MAP={I:[[["l","r"],["l","r"],["l","r","c"],["l","r"]],["l",null,"c","r"],[["l","r"],["l","r"],["l","r","c"],["l","r"]],["l",null,"c","r"]],L:[["r","c","l",["l","r"]],[["l","r"],["l","r","c"],"r","l"],["l","c","r",["l","r"]],[["l","r"],["l","r","c"],"l","r"]],RL:[["r","c","l",["l","r"]],[["l","r"],["c","l","r"],"l","r"],["l","c","r",["l","r"]],[["l","r"],["c","l","r"],"l","r"]],T:[["l",["l","r"],["c","r"],["l","r"]],[["l","r"],"r","c","l"],["r",["l","r"],["l","c"],["l","r"]],[["l","r"],"l","c","r"]],Z:[[["l","r"],["c","r"],"l",["l","r"]],["l",["c","r"],"l","r"],[["l","r"],["c","r"],"l",["l","r"]],["l",["c","r"],"l","r"]],RZ:[[["l","r"],["c","r"],"l",["l","r"]],["r",["c","l"],"r","l"],[["l","r"],["c","r"],"l",["l","r"]],["r",["c","l"],"r","l"]]},app.const.NEXT_FIGURE_POSITION={I:[[t,i+r],[i,i+r],[s,i+r],[n,i+r]],C:[[i,i],[s,i],[i,s],[s,s]],L:[[i,t],[i,i],[i,s],[s,s]],RL:[[s,t],[s,i],[s,s],[i,s]],T:[[i+r,s],[t+r,i],[i+r,i],[s+r,i]],Z:[[t+r,i],[i+r,i],[i+r,s],[s+r,s]],RZ:[[s+r,i],[i+r,i],[i+r,s],[t+r,s]]}}();var app=app||{};!function(){"use strict";app.classes=app.classes||{},app.classes.helper={getRandomInt:function(t,e){return Math.floor(Math.random()*(e-t+1))+t}}}();var app=app||{};!function(){"use strict";app.CellModel=Backbone.Model.extend({defaults:{x:0,y:0,left:!1,right:!1,center:!1,stroke:"",fill:""}})}();var app=app||{};!function(){"use strict";app.FigureCollection=Backbone.Collection.extend({model:app.CellModel,initialize:function(){},createFigure:function(t){var e=app.const.CELL;app.const.WIDTH/2-e/2;this.currentState=0,this.type=app.const.TYPE_MAP[t],this.reset(app.const.FIGURE[t]),this.setColor()},moveToCenter:function(){var t=app.const.NEXT_FIGURE_POSITION[this.type];this.each(function(e,i){e.set({x:t[i][0],y:t[i][1]})})},setColor:function(){this.each(function(t){t.set({fill:app.const.FIGURE_COLORS[this.type][0],stroke:app.const.FIGURE_COLORS[this.type][1]})}.bind(this))},getNewArr:function(){this.currentState>3&&(this.currentState=0);var t=app.const.TRANSFORM_MAP[this.type][this.currentState],e=app.const.POSITION_MAP[this.type][this.currentState],i={l:"left",r:"right",c:"center"},s=[],n=app.const.CELL;return this.each(function(r,o){var a={};t[o]?_.isString(t[o])?(a.x=this.at(t[o]).get("x"),a.y=this.at(t[o]).get("y")):(a.x=r.get("x")+t[o][0]*n,a.y=r.get("y")+t[o][1]*n):(a.x=r.get("x"),a.y=r.get("y")),e[o]&&(_.isString(e[o])?a[i[e[o]]]=!0:_.each(e[o],function(t){a[i[t]]=!0})),s.push(a)}.bind(this)),s},rotateSuccess:function(){++this.currentState},getCustom:function(){return{type:this.type,currentState:this.currentState}},setCustom:function(t){this.type=t.type,this.currentState=t.currentState}})}();var app=app||{};!function(){app.Canvas=Backbone.View.extend({initialize:function(){this.ctx=this.el.getContext("2d"),this.cellRect=app.const.CELL},setCtx:function(t,e){this.ctx.fillStyle=t||app.const.FILL_STYLE,this.ctx.strokeStyle=e||app.const.STROKE_STYLE},drawCell:function(t){var e=t.get("x"),i=t.get("y");this.setCtx(t.get("fill"),t.get("stroke")),this.ctx.strokeRect(e,i,this.cellRect-.5,this.cellRect-.5),this.ctx.fillRect(e,i,this.cellRect-2,this.cellRect-2)},clear:function(){this.ctx.clearRect(0,0,app.const.WIDTH,app.const.HEIGHT)}})}();var app=app||{};!function(){"use strict";app.CanvasView=app.Canvas.extend({el:"#cnvs",initialize:function(){this.el.height=app.const.HEIGHT,this.el.width=app.const.WIDTH,app.Canvas.prototype.initialize.apply(this),this.setCtx(),this.ctx.textAlign="center",this.ctx.textBaseline="middle",this.speed=app.const.SPEED_START,this.points=0,this.statePlaying=null,this.blockMoveDown=!1,this.removeRow=!1,this.nextFigureType=null,this.readyToStart=!0,this.CC=new app.FigureCollection,this.FC=new app.FigureCollection,app.eventDispatcher.on("startPlay removedFillRow",this.startLoop,this),app.eventDispatcher.on("endLoop",this.updatePoints,this),app.eventDispatcher.on("removeRow",this.updatePoints,this),$(window).on("keyup",this.keyUpController.bind(this)),$(window).on("keydown",this.keyDownController.bind(this)),this.renderCanvasControl()},updatePoints:function(t){this.points+=t},render:function(){this.statePlaying&&!this.removeRow&&(this.moveFigure(),this.draw(),this.check())},renderCanvasControl:function(){this.ctx.font="bold 30px Monospaced",this.setCtx(app.const.GAME_OVER_FILL),this.ctx.fillRect(0,0,app.const.WIDTH,app.const.HEIGHT);var t={},e={};this.gameOverState?(t.text="GAME OVER!",e.text="press space to restart",t.x=120,e.x=120):this.readyToStart&&(t.text="START!",e.text="press space to start",t.x=120,e.x=120),t.y=app.const.HEIGHT/2-15,e.y=t.y+30,this.setCtx("#fff"),this.ctx.fillText(t.text,t.x,t.y),this.ctx.font="16px Monospaced",this.ctx.fillText(e.text,e.x,e.y)},keyDownController:function(t){this.statePlaying&&40==t.keyCode&&this.speed<app.const.SPEED_MAX&&(this.speed+=app.const.SPEED_STEP,this.play())},keyUpController:function(t){if(32==t.keyCode&&!this.statePlaying)return this.gameOverState&&(this.gameOverState=!1,this.FC.reset(),app.eventDispatcher.trigger("startNewGame")),void this.startLoop();if(this.statePlaying){var e=t.ctrlKey;e&&(81==t.keyCode&&(this.endLoop(),!this.removeRow&&this.statePlaying&&this.startLoop()),88==t.keyCode&&this.gameOver()),40==t.keyCode&&(this.speed=app.const.SPEED_START,this.play()),37==t.keyCode&&(this.blockMoveDown=!0,this.moveFigure("left"),this.blockMoveDown=!1),39==t.keyCode&&(this.blockMoveDown=!0,this.moveFigure("right"),this.blockMoveDown=!1),38==t.keyCode&&this.rotate()&&console.log("rotate")}},gameOver:function(){this.stop(),this.statePlaying=null,this.removeRow=!1,this.gameOverState=!0,app.eventDispatcher.trigger("gameover"),this.renderCanvasControl()},checkLeft:function(t){var e=t.where({left:!0}),i=!0;return _.each(e,function(t){var e=this.FC.findWhere({x:t.get("x")-this.cellRect,y:t.get("y")});if(t.get("x")<=0||e)return i=!1,!0}.bind(this)),i},checkRight:function(t){var e=t.where({right:!0}),i=!0;return _.each(e,function(t){var e=this.FC.findWhere({x:t.get("x")+this.cellRect,y:t.get("y")});if(t.get("x")+this.cellRect>=app.const.WIDTH||e)return i=!1,!0}.bind(this)),i},check:function(){var t=!0;return this.CC.find(function(e){if(e.get("y")+this.cellRect==app.const.HEIGHT)return t=!1,e}.bind(this)),t?(this.CC.find(function(e){var i=e.get("x"),s=e.get("y")+this.cellRect;if(this.FC.findWhere({x:i,y:s}))return t=!1,e}.bind(this)),void(t||(this.endLoop(),this.startLoop()))):(this.endLoop(),void this.startLoop())},checkFillRow:function(){var t=this.FC.groupBy("y"),e=_.find(t,function(t){return t.length>=app.const.ROW_WIDTH});e?(e=_.sortBy(e,"x"),app.eventDispatcher.trigger("removeRow",app.const.REMOVE_ROW),this.removeFillRow(e)):this.removeRow&&(this.removeRow=!1,app.eventDispatcher.trigger("removedFillRow"))},rotate:function(){if("C"==this.CC.type)return!1;var t=new app.FigureCollection;if(t.add(this.CC.getNewArr()),this.checkLeft(t)&&this.checkRight(t)){var e=t.find(function(t){if(t.get("y")+this.cellRect>=app.const.HEIGHT)return t}.bind(this));if(e)return;this.CC.rotateSuccess(),t.setCustom(this.CC.getCustom()),t.setColor(),this.CC=t}},startLoop:function(){this.readyToStart=!1,this.removeRow||this.gameOverState||(null===this.nextFigureType?this.CC.createFigure(app.classes.helper.getRandomInt(0,6)):this.CC.createFigure(this.nextFigureType),this.nextFigureType=app.classes.helper.getRandomInt(0,6),app.eventDispatcher.trigger("nextFigure",this.nextFigureType),this.play())},endLoop:function(){app.eventDispatcher.trigger("endLoop",app.const.END_LOOP),this.CC.find(function(t){return t.get("y")<=0})&&this.gameOver(),this.CC.each(function(t){this.FC.add(t)}.bind(this)),this.checkFillRow()},moveFigure:function(t){"left"==t?this.checkLeft(this.CC)?this.CC.each(function(t){t.set("x",t.get("x")-this.cellRect)}.bind(this)):this.blockMoveDown=!1:"right"==t?this.checkRight(this.CC)?this.CC.each(function(t){t.set("x",t.get("x")+this.cellRect)}.bind(this)):this.blockMoveDown=!1:this.blockMoveDown||this.CC.each(function(t){t.set("y",t.get("y")+this.cellRect)}.bind(this))},play:function(){this.playId&&this.stop(),this.playId=setInterval(this.render.bind(this),1e3/this.speed),this.statePlaying="play"},stop:function(){clearInterval(this.playId)},draw:function(){this.clear(),this.drawFigures()},drawFigures:function(){this.CC.each(this.drawCell,this),this.FC.each(this.drawCell,this)},removeFillRow:function(t){this.removeRow=!0;var e=t[0].get("y"),i=setInterval(function(){return this.clear(),t.length?(this.FC.remove(t[t.length-1]),this.FC.each(this.drawCell,this),void t.pop()):(clearInterval(i),this.FC.each(function(t){t.get("y")<e&&t.set("y",t.get("y")+this.cellRect)}.bind(this)),this.FC.each(this.drawCell,this),void this.checkFillRow())}.bind(this),app.const.REMOVE_CELL_ANIMATION_TIME);this.stop()}})}();var app=app||{};!function(){"use strict";app.NextFigureView=app.Canvas.extend({el:"#nextFigure",initialize:function(){this.el.height=6*app.const.CELL,this.el.width=6*app.const.CELL,app.Canvas.prototype.initialize.apply(this),this.NF=new app.FigureCollection,app.eventDispatcher.on("nextFigure",this.render,this),app.eventDispatcher.on("gameover",this.gameOver,this)},render:function(t){this.NF.createFigure(t),this.NF.moveToCenter(),this.clear(),this.NF.each(this.drawCell,this)},gameOver:function(){this.clear()}})}();var app=app||{};!function(){"use strict";app.PanelView=Backbone.View.extend({el:"#panel",points:0,events:{"click #playerName span":"showInputName","click #show_all_score":"toggleScore","click #reset_score":"resetScore","blur #playerName input":"setName","keydown #playerName input":"keyDownControl"},initialize:function(){this.score=[],this.allScore=!1,this.blocks={name:this.$el.find("#playerName span"),input:this.$el.find("#playerName input"),score:this.$el.find("#score"),all_score:this.$el.find("#show_all_score"),reset_score:this.$el.find("#reset_score")},(this.playerName=localStorage.getItem("playerName"))||(this.playerName="Player"),localStorage.getItem("playerScore")&&(this.score=JSON.parse(localStorage.getItem("playerScore")),this.blocks.reset_score.removeClass("hidden")),this.render(),app.eventDispatcher.on("endLoop",this.updatePoints,this),app.eventDispatcher.on("removeRow",this.updatePoints,this),app.eventDispatcher.on("gameover",this.gameOver,this),app.eventDispatcher.on("startNewGame",this.resetPoints,this)},render:function(){this.blocks.name.text(this.playerName),this.renderScoreTable()},renderScoreTable:function(){this.blocks.score.html("");for(var t=this.score.length-1,e=0;t>=0;t--,e++)e<app.const.SCORE_SIZE_ROW?this.blocks.score.append("<tr><td>"+this.score[t].name+"</td><td>"+this.score[t].points+"</td></tr>"):this.blocks.score.append('<tr class="hidden no_top_score"><td>'+this.score[t].name+"</td><td>"+this.score[t].points+"</td></tr>");this.score.length>app.const.SCORE_SIZE_ROW&&this.blocks.all_score.removeClass("hidden"),this.score.length&&this.blocks.reset_score.removeClass("hidden")},toggleScore:function(t){t.preventDefault(),this.blocks.score.find(".no_top_score").toggleClass("hidden"),this.allScore=!this.allScore,this.allScore?this.blocks.all_score.text("hide all"):this.blocks.all_score.text("show all")},resetScore:function(t){t.preventDefault(),this.blocks.reset_score.addClass("hidden"),this.blocks.all_score.addClass("hidden"),localStorage.removeItem("playerScore"),this.score=[],this.renderScoreTable()},resetPoints:function(){this.points=0,this.updatePoints(0)},updatePoints:function(t){this.points+=t,this.$el.find(".points span").text(this.points)},gameOver:function(){this.setScore({name:this.playerName,points:this.points}),this.renderScoreTable()},showInputName:function(){this.blocks.name.hide(),this.blocks.input.val(this.playerName).show(),this.blocks.input[0].setSelectionRange(this.playerName.length,this.playerName.length)},keyDownControl:function(t){13==t.keyCode&&(t.preventDefault(),this.setName())},setName:function(){this.playerName=this.blocks.input[0].value,this.blocks.name.text(this.playerName),localStorage.setItem("playerName",this.playerName),this.blocks.input.hide(),this.blocks.name.show()},setScore:function(t){if(this.score.length){var e=_.sortedIndex(this.score,t,"points");if(e==this.score.length)this.score.push(t);else{var i=[];_.each(this.score,function(s,n){e==n&&i.push(t),i.push(s)}),this.score=i}}else this.score.push(t);localStorage.setItem("playerScore",JSON.stringify(this.score))}})}();var app=app||{};!function(){"use strict";var t=Backbone.View.extend({el:"#page",initialize:function(){app.views={},app.models={},app.collections={},app.eventDispatcher=_.extend({},Backbone.Events),app.views.canvas=new app.CanvasView,app.views.panel=new app.PanelView,app.views.next_figure=new app.NextFigureView}});$(document).ready(function(){app.page=new t})}();
//# sourceMappingURL=main.min.js.map
