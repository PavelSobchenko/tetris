var app=app||{};!function(){app.const={WIDTH:216,HEIGHT:280,CELL:8,SPEED_START:5,SPEED_MAX:45,SPEED_STEP:10,SIZE_FIGURE:4,STROKE_STYLE:"#3b6cba",FILL_STYLE:"#1464e5",REMOVE_CELL_ANIMATION_TIME:50};var t=app.const.CELL,e=app.const.WIDTH/2-t/2;app.const.ROW_WIDTH=app.const.WIDTH/t,app.const.FIGURE=[[{x:e-2*t,y:-t,left:!0},{x:e-t,y:-t},{x:e,y:-t,center:!0},{x:e+t,y:-t,right:!0}],[{x:e-t,y:-(2*t),left:!0},{x:e,y:-(2*t),right:!0},{x:e-t,y:-t,left:!0},{x:e,y:-t,right:!0}],[{x:e,y:-(3*t),left:!0,right:!0},{x:e,y:-(2*t),left:!0,right:!0,center:!0},{x:e,y:-t,left:!0},{x:e+t,y:-t,right:!0}],[{x:e,y:-(3*t),left:!0,right:!0},{x:e,y:-(2*t),left:!0,right:!0,center:!0},{x:e,y:-t,right:!0},{x:e-t,y:-t,left:!0}],[{x:e,y:0-t,right:!0,left:!0},{x:e-t,y:-(2*t),left:!0},{x:e,y:0-2*t,center:!0},{x:e+t,y:-(2*t),right:!0}],[{x:e-t,y:0-2*t,left:!0},{x:e,y:0-2*t,right:!0,center:!0},{x:e,y:0-t,left:!0},{x:e+t,y:0-t,right:!0}],[{x:e+t,y:0-2*t,right:!0},{x:e,y:0-2*t,center:!0,left:!0},{x:e,y:0-t,right:!0},{x:e-t,y:0-t,left:!0}]],app.const.TYPE_MAP=["I","C","L","RL","T","Z","RZ"],app.const.TRANSFORM_MAP={I:[[[2,-2],[1,-1],null,[-1,1]],[[-2,2],[-1,1],null,[1,-1]],[[2,-2],[1,-1],null,[-1,1]],[[-2,2],[-1,1],null,[1,-1]]],L:[[[1,1],null,[-1,-1],[-2,0]],[[-1,1],null,[1,-1],[0,-2]],[[-1,-1],null,[1,1],[2,0]],[[1,-1],null,[-1,1],[0,2]]],RL:[[[1,1],null,[-1,-1],[0,-2]],[[-1,1],null,[1,-1],[2,0]],[[-1,-1],null,[1,1],[0,2]],[[1,-1],null,[-1,1],[-2,0]]],T:[["1",[1,-1],null,"0"],["1",[1,1],null,"0"],["1",[-1,1],null,"0"],["1",[-1,-1],null,"0"]],Z:[[[1,-1],null,"0",[-2,0]],[[-1,1],null,[1,1],[2,0]],[[1,-1],null,"0",[-2,0]],[[-1,1],null,[1,1],[2,0]]],RZ:[["2",null,[-1,-1],[0,-2]],[[1,-1],null,"0",[0,2]],["2",null,[-1,-1],[0,-2]],[[1,-1],null,"0",[0,2]]]},app.const.POSITION_MAP={I:[[["l","r"],["l","r"],["l","r","c"],["l","r"]],["l",null,"c","r"],[["l","r"],["l","r"],["l","r","c"],["l","r"]],["l",null,"c","r"]],L:[["r","c","l",["l","r"]],[["l","r"],["l","r","c"],"r","l"],["l","c","r",["l","r"]],[["l","r"],["l","r","c"],"l","r"]],RL:[["r","c","l",["l","r"]],[["l","r"],["c","l","r"],"l","r"],["l","c","r",["l","r"]],[["l","r"],["c","l","r"],"l","r"]],T:[["l",["l","r"],["c","r"],["l","r"]],[["l","r"],"r","c","l"],["r",["l","r"],["l","c"],["l","r"]],[["l","r"],"l","c","r"]],Z:[[["l","r"],["c","r"],"l",["l","r"]],["l",["c","r"],"l","r"],[["l","r"],["c","r"],"l",["l","r"]],["l",["c","r"],"l","r"]],RZ:[[["l","r"],["c","r"],"l",["l","r"]],["r",["c","l"],"r","l"],[["l","r"],["c","r"],"l",["l","r"]],["r",["c","l"],"r","l"]]}}();var app=app||{};!function(){"use strict";app.classes=app.classes||{},app.classes.helper={getRandomInt:function(t,e){return Math.floor(Math.random()*(e-t+1))+t}}}();var app=app||{};!function(){"use strict";app.CellModel=Backbone.Model.extend({defaults:{x:0,y:0,left:!1,right:!1,center:!1}})}();var app=app||{};!function(){"use strict";app.FigureCollection=Backbone.Collection.extend({model:app.CellModel,initialize:function(){},createFigure:function(t){var e=app.const.CELL;app.const.WIDTH/2-e/2;this.currentState=0,this.type=app.const.TYPE_MAP[t],this.reset(app.const.FIGURE[t])},rotateFigure:function(){},getNewArr:function(){this.currentState>3&&(this.currentState=0);var t=app.const.TRANSFORM_MAP[this.type][this.currentState],e=app.const.POSITION_MAP[this.type][this.currentState],i={l:"left",r:"right",c:"center"},n=[],l=app.const.CELL;return this.each(function(s,r){var c={};t[r]?_.isString(t[r])?(c.x=this.at(t[r]).get("x"),c.y=this.at(t[r]).get("y")):(c.x=s.get("x")+t[r][0]*l,c.y=s.get("y")+t[r][1]*l):(c.x=s.get("x"),c.y=s.get("y")),e[r]&&(_.isString(e[r])?c[i[e[r]]]=!0:_.each(e[r],function(t){c[i[t]]=!0})),n.push(c)}.bind(this)),n},rotateSuccess:function(){++this.currentState},getCustom:function(){return{type:this.type,currentState:this.currentState}},setCustom:function(t){this.type=t.type,this.currentState=t.currentState}})}();var app=app||{};!function(){"use strict";app.CanvasView=Backbone.View.extend({el:"#cnvs",initialize:function(){this.el.style.border="1px solid #333",this.el.height=app.const.HEIGHT,this.el.width=app.const.WIDTH,this.ctx=this.el.getContext("2d"),this.setCtx(),this.speed=app.const.SPEED_START,this.cellRect=app.const.CELL,this.statePlaying=null,this.blockMoveDown=!1,this.removeRow=!1,this.CC=new app.FigureCollection,this.FC=new app.FigureCollection,app.eventDispatcher.on("startPlay removedFillRow",this.startLoop,this),$(window).on("keyup",this.keyUpController.bind(this)),$(window).on("keydown",this.keyDownController.bind(this))},render:function(){this.statePlaying&&!this.removeRow&&(this.moveFigure(),this.draw(),this.check())},setCtx:function(t){t?(this.ctx.fillStyle=t.fill_style||app.const.FILL_STYLE,this.ctx.strokeStyle=t.stroke_style||app.const.STROKE_STYLE):(this.ctx.fillStyle=app.const.FILL_STYLE,this.ctx.strokeStyle=app.const.STROKE_STYLE)},keyDownController:function(t){this.statePlaying&&40==t.keyCode&&this.speed<app.const.SPEED_MAX&&(this.speed+=app.const.SPEED_STEP,this.play())},keyUpController:function(t){if(this.statePlaying){var e=t.ctrlKey;e&&(81==t.keyCode&&(this.endLoop(),this.removeRow||this.startLoop()),88==t.keyCode&&this.gameOver()),40==t.keyCode&&(this.speed=app.const.SPEED_START,this.play()),37==t.keyCode&&(this.blockMoveDown=!0,this.moveFigure("left"),this.blockMoveDown=!1),39==t.keyCode&&(this.blockMoveDown=!0,this.moveFigure("right"),this.blockMoveDown=!1),38==t.keyCode&&this.checkRotate()&&console.log("rotate")}},gameOver:function(){this.stop(),this.statePlaying=null,app.eventDispatcher.trigger("gameover"),console.log("gameover")},checkLeft:function(t){var e=t.where({left:!0}),i=!0;return _.each(e,function(t){var e=this.FC.findWhere({x:t.get("x")-this.cellRect,y:t.get("y")});if(t.get("x")<=0||e)return i=!1,!0}.bind(this)),i},checkRight:function(t){var e=t.where({right:!0}),i=!0;return _.each(e,function(t){var e=this.FC.findWhere({x:t.get("x")+this.cellRect,y:t.get("y")});if(t.get("x")+this.cellRect>=app.const.WIDTH||e)return i=!1,!0}.bind(this)),i},check:function(){var t=!0;return this.CC.find(function(e){if(e.get("y")+this.cellRect==app.const.HEIGHT)return t=!1,e}.bind(this)),t?(this.CC.find(function(e){var i=e.get("x"),n=e.get("y")+this.cellRect;if(this.FC.findWhere({x:i,y:n}))return t=!1,e}.bind(this)),void(t||(this.endLoop(),this.CC.findWhere({y:0})?this.gameOver():this.removeRow||this.startLoop()))):(this.endLoop(),void(this.removeRow||this.startLoop()))},checkFillRow:function(){var t=this.FC.groupBy("y"),e=_.find(t,function(t){return t.length>=app.const.ROW_WIDTH});e?(e=_.sortBy(e,"x"),this.removeFillRow(e)):(this.removeRow=!1,app.eventDispatcher.trigger("removedFillRow"))},checkRotate:function(){if("C"==this.CC.type)return!1;var t=new app.FigureCollection;if(t.add(this.CC.getNewArr()),this.checkLeft(t)&&this.checkRight(t)){var e=t.find(function(t){if(t.get("y")+this.cellRect>=app.const.HEIGHT)return t}.bind(this));if(e)return;this.CC.rotateSuccess(),t.setCustom(this.CC.getCustom()),this.CC=t}},startLoop:function(){this.CC.createFigure(0),this.play()},endLoop:function(){this.CC.each(function(t){this.FC.add(t)}.bind(this)),this.checkFillRow()},moveFigure:function(t){"left"==t?this.checkLeft(this.CC)?this.CC.each(function(t){t.set("x",t.get("x")-this.cellRect)}.bind(this)):this.blockMoveDown=!1:"right"==t?this.checkRight(this.CC)?this.CC.each(function(t){t.set("x",t.get("x")+this.cellRect)}.bind(this)):this.blockMoveDown=!1:this.blockMoveDown||this.CC.each(function(t){t.set("y",t.get("y")+this.cellRect)}.bind(this))},play:function(){this.playId&&this.stop(),this.playId=setInterval(this.render.bind(this),1e3/this.speed),this.statePlaying="play"},stop:function(){clearInterval(this.playId)},draw:function(){this.clear(),this.drawFigures()},drawFigures:function(){this.CC.each(this.drawCell,this),this.FC.each(this.drawCell,this)},drawCell:function(t){var e=t.get("x"),i=t.get("y");this.ctx.strokeRect(e,i,this.cellRect-.5,this.cellRect-.5),this.ctx.fillRect(e,i,this.cellRect-2,this.cellRect-2)},removeFillRow:function(t){this.removeRow=!0;var e=t[0].get("y"),i=setInterval(function(){return this.clear(),t.length?(this.FC.remove(t[t.length-1]),this.FC.each(this.drawCell,this),void t.pop()):(clearInterval(i),this.FC.each(function(t){t.get("y")<e&&t.set("y",t.get("y")+this.cellRect)}.bind(this)),this.FC.each(this.drawCell,this),void this.checkFillRow())}.bind(this),app.const.REMOVE_CELL_ANIMATION_TIME);this.stop()},clear:function(){this.ctx.clearRect(0,0,app.const.WIDTH,app.const.HEIGHT)}})}();var app=app||{};!function(){"use strict";var t=Backbone.View.extend({el:"#page",initialize:function(){app.views={},app.models={},app.collections={},app.eventDispatcher=_.extend({},Backbone.Events),app.views.canvas=new app.CanvasView,this.startPlay()},startPlay:function(){app.eventDispatcher.trigger("startPlay")}});$(document).ready(function(){app.page=new t})}();
//# sourceMappingURL=main.min.js.map
