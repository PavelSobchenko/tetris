{"version":3,"sources":["Constants.js","Helper.js","Cell.js","FigureCollection.js","Canvas.js","Page.js"],"names":["app","const","WIDTH","HEIGHT","CELL","SPEED_START","SPEED_MAX","SPEED_STEP","SIZE_FIGURE","STROKE_STYLE","FILL_STYLE","REMOVE_CELL_ANIMATION_TIME","r","c","ROW_WIDTH","FIGURE","x","y","left","center","right","TYPE_MAP","TRANSFORM_MAP","I","L","RL","T","Z","RZ","POSITION_MAP","classes","helper","getRandomInt","min","max","Math","floor","random","CellModel","Backbone","Model","extend","defaults","FigureCollection","Collection","model","initialize","createFigure","intg","this","currentState","type","reset","rotateFigure","getNewArr","data","position","map","l","tmp","each","cell","i","item","_","isString","at","get","name","push","bind","rotateSuccess","getCustom","setCustom","config","CanvasView","View","el","style","border","height","width","ctx","getContext","setCtx","speed","cellRect","statePlaying","blockMoveDown","removeRow","CC","FC","eventDispatcher","on","startLoop","$","window","keyUpController","keyDownController","render","moveFigure","draw","check","fillStyle","fill_style","strokeStyle","stroke_style","e","keyCode","play","ctrl","ctrlKey","endLoop","gameOver","checkRotate","console","log","stop","trigger","checkLeft","collection","cells","where","result","fillCell","findWhere","checkRight","cont","find","checkFillRow","group","groupBy","row","arr","length","sortBy","removeFillRow","tmpCollection","add","no_valid_cell","direct","set","playId","setInterval","clearInterval","clear","drawFigures","drawCell","strokeRect","fillRect","interval","remove","pop","clearRect","Page","views","models","collections","Events","canvas","startPlay","document","ready","page"],"mappings":"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","file":"main.min.js","sourcesContent":["var app = app || {};\n\n(function () {\n    app.const = {\n        // canvas\n        WIDTH: 216,\n        HEIGHT: 280,\n        CELL: 8,\n        SPEED_START: 5,\n        SPEED_MAX: 45,\n        SPEED_STEP: 10,\n        SIZE_FIGURE: 4,\n        STROKE_STYLE: '#3b6cba',\n        FILL_STYLE: '#1464e5',\n        REMOVE_CELL_ANIMATION_TIME: 50 // ms\n    };\n    var r = app.const.CELL, c = (app.const.WIDTH/2)-(r/2);\n\n    // count cells in one row\n    app.const.ROW_WIDTH = app.const.WIDTH/r;\n\n    // figures\n    app.const.FIGURE = [\n        [\n            {x:(c-(r*2)), y:-r, left: true},\n            {x:(c-r), y:-r},\n            {x:c, y:-r, center: true},\n            {x:(c+r), y:-r, right: true}\n        ], // row\n        [\n            {x:(c-r), y:-(r*2), left: true},\n            {x:c, y:-(r*2), right: true},\n            {x:(c-r), y:-r, left: true},\n            {x:c, y:-r, right:true}\n        ], // rect\n        [\n            {x:c, y:-(r*3), left: true, right: true},\n            {x:c, y:-(r*2), left: true, right: true, center: true},\n            {x:c, y:-r, left: true},\n            {x:(c+r), y:-r, right: true}\n        ], // L\n        [\n            {x:c, y:-(r*3), left: true, right: true},\n            {x:c, y:-(r*2), left: true, right: true, center: true},\n            {x:c, y:-r, right: true},\n            {x:c-r, y:-r, left: true}\n        ], // RL\n        [\n            {x:c,y:0-r, right: true, left: true},\n            {x:(c-r),y:-(r*2) , left: true},\n            {x:c,y:0-(r*2), center: true},\n            {x:(c+r),y:-(r*2), right: true}\n        ], // T\n        [\n            {x:c-r, y: 0-(r*2), left: true},\n            {x:c, y: 0-(r*2), right: true, center: true},\n            {x:c, y: 0-r, left: true},\n            {x:c+r, y: 0-r, right: true}\n        ], // Z\n        [\n            {x: c+r, y: 0-(r*2), right: true},\n            {x: c, y: 0-(r*2), center: true, left: true},\n            {x: c, y: 0-r, right: true},\n            {x: c-r, y: 0-r, left: true}\n        ] // RZ\n    ];\n    app.const.TYPE_MAP = ['I', 'C', 'L', 'RL', 'T', 'Z', 'RZ'];\n    app.const.TRANSFORM_MAP = {\n        'I': [\n            [[2, -2], [1, -1], null, [-1, 1]],\n            [[-2, 2], [-1, 1], null, [1, -1]],\n            [[2, -2], [1, -1], null, [-1, 1]],\n            [[-2, 2], [-1, 1], null, [1, -1]]\n        ],\n        'L': [\n            [[1, 1], null, [-1, -1], [-2, 0]],\n            [[-1, 1], null, [1, -1], [0, -2]],\n            [[-1, -1], null, [1, 1], [2, 0]],\n            [[1, -1], null, [-1, 1], [0, 2]]\n        ],\n        'RL': [\n            [[1, 1], null, [-1, -1], [0, -2]],\n            [[-1, 1], null, [1, -1], [2, 0]],\n            [[-1, -1], null, [1, 1], [0, 2]],\n            [[1, -1], null, [-1, 1], [-2, 0]]\n        ],\n        'T': [\n            ['1', [1, -1], null, '0'],\n            ['1', [1, 1], null, '0'],\n            ['1', [-1, 1], null, '0'],\n            ['1', [-1, -1], null, '0']\n        ],\n        'Z': [\n            [[1, -1], null, '0', [-2, 0]],\n            [[-1, 1], null, [1, 1], [2, 0]],\n            [[1, -1], null, '0', [-2, 0]],\n            [[-1, 1], null, [1, 1], [2, 0]]\n        ],\n        'RZ': [\n            ['2', null, [-1, -1], [0, -2]],\n            [[1, -1], null, '0', [0, 2]],\n            ['2', null, [-1, -1], [0, -2]],\n            [[1, -1], null, '0', [0, 2]]\n        ]\n    };\n    app.const.POSITION_MAP = {\n        'I': [\n            [['l', 'r'], ['l', 'r'], ['l', 'r', 'c'], ['l', 'r']],\n            ['l', null, 'c', 'r'],\n            [['l', 'r'], ['l', 'r'], ['l', 'r', 'c'], ['l', 'r']],\n            ['l', null, 'c', 'r']\n        ],\n        'L': [\n            ['r', 'c', 'l', ['l', 'r']],\n            [['l', 'r'], ['l', 'r', 'c'], 'r', 'l'],\n            ['l', 'c', 'r', ['l', 'r']],\n            [['l', 'r'], ['l', 'r', 'c'], 'l', 'r']\n        ],\n        'RL': [\n            ['r', 'c', 'l', ['l', 'r']],\n            [['l', 'r'], ['c', 'l', 'r'], 'l', 'r'],\n            ['l', 'c', 'r', ['l', 'r']],\n            [['l', 'r'], ['c', 'l', 'r'], 'l', 'r']\n        ],\n        'T': [\n            ['l', ['l', 'r'], ['c', 'r'], ['l', 'r']],\n            [['l', 'r'], 'r', 'c', 'l'],\n            ['r', ['l', 'r'], ['l', 'c'], ['l', 'r']],\n            [['l', 'r'], 'l', 'c', 'r']\n        ],\n        'Z': [\n            [['l', 'r'], ['c', 'r'], 'l', ['l', 'r']],\n            ['l', ['c', 'r'], 'l', 'r'],\n            [['l', 'r'], ['c', 'r'], 'l', ['l', 'r']],\n            ['l', ['c', 'r'], 'l', 'r']\n        ],\n        'RZ': [\n            [['l', 'r'], ['c', 'r'], 'l', ['l', 'r']],\n            ['r', ['c', 'l'], 'r', 'l'],\n            [['l', 'r'], ['c', 'r'], 'l', ['l', 'r']],\n            ['r', ['c', 'l'], 'r', 'l']\n        ]\n    };\n})();","var app = app || {};\n\n(function () {\n    \"use strict\";\n    \n    app.classes = app.classes || {}; \n    \n    app.classes.helper = {\n        getRandomInt: function (min, max) {\n            return Math.floor(Math.random() * (max - min + 1)) + min;\n        }\n    };\n})();","var app = app || {};\n\n(function () {\n    'use strict';\n    app.CellModel = Backbone.Model.extend({\n        defaults: {\n            x: 0,\n            y: 0,\n            left: false,\n            right: false,\n            center: false\n        }\n    });\n})();","var app = app || {};\n\n(function () {\n    \"use strict\";\n    app.FigureCollection = Backbone.Collection.extend({\n        model: app.CellModel,\n        initialize: function () {\n\n        },\n        createFigure: function (intg) {\n            var r = app.const.CELL, c = (app.const.WIDTH/2)-(r/2);\n            this.currentState = 0;\n            this.type = app.const.TYPE_MAP[intg];\n            this.reset(app.const.FIGURE[intg]);\n        },\n        rotateFigure: function () {\n\n        },\n        getNewArr: function () {\n            if(this.currentState > 3)\n                this.currentState = 0;\n\n            var data = app.const.TRANSFORM_MAP[this.type][this.currentState];\n            var position = app.const.POSITION_MAP[this.type][this.currentState];\n            var map = {\n                'l': 'left',\n                'r': 'right',\n                'c': 'center'\n            };\n            var tmp = [];\n            var r = app.const.CELL;\n\n            this.each(function (cell, i) {\n                var item = {};\n\n                if(data[i]) {\n                    if(_.isString(data[i])) {\n                        item.x = this.at(data[i]).get('x');\n                        item.y = this.at(data[i]).get('y');\n                    } else {\n                        item.x = cell.get('x') + (data[i][0]*r);\n                        item.y = cell.get('y') + (data[i][1]*r);\n                    }\n                } else {\n                    item.x = cell.get('x');\n                    item.y = cell.get('y');\n                }\n\n                if(position[i]) {\n                    if(_.isString(position[i])) {\n                        item[map[position[i]]] = true;\n                    } else {\n                        _.each(position[i], function (name) {\n                            item[map[name]] = true;\n                        });\n                    }\n                }\n                tmp.push(item);\n            }.bind(this));\n\n            return tmp;\n        },\n        rotateSuccess: function () {\n            ++this.currentState;\n        },\n        getCustom: function () {\n            return {\n                type: this.type,\n                currentState: this.currentState\n            }\n        },\n        setCustom: function (config) {\n            this.type = config.type;\n            this.currentState = config.currentState;\n        }\n    });\n})();","var app = app || {};\n\n(function () {\n    \"use strict\";\n    app.CanvasView = Backbone.View.extend({\n        el: '#cnvs',\n        initialize: function () {\n            this.el.style.border = '1px solid #333';\n            this.el.height = app.const.HEIGHT;\n            this.el.width = app.const.WIDTH;\n\n            this.ctx = this.el.getContext(\"2d\");\n            this.setCtx();\n\n            this.speed = app.const.SPEED_START;\n            this.cellRect = app.const.CELL;\n            this.statePlaying = null;\n            this.blockMoveDown = false;\n            this.removeRow = false;\n            this.CC = new app.FigureCollection(); // current figure\n            this.FC = new app.FigureCollection(); // array of filled cells\n\n            app.eventDispatcher.on('startPlay removedFillRow', this.startLoop, this);\n            $(window).on('keyup', this.keyUpController.bind(this));\n            $(window).on('keydown', this.keyDownController.bind(this));\n        },\n        render: function () {\n            if(!this.statePlaying || this.removeRow)\n                return;\n\n            this.moveFigure();\n            this.draw();\n            this.check();\n        },\n\n        // set func\n        setCtx: function (config) {\n            if(config) {\n                this.ctx.fillStyle = config.fill_style || app.const.FILL_STYLE;\n                this.ctx.strokeStyle = config.stroke_style || app.const.STROKE_STYLE;\n            } else {\n                this.ctx.fillStyle = app.const.FILL_STYLE;\n                this.ctx.strokeStyle = app.const.STROKE_STYLE;\n            }\n        },\n        keyDownController: function (e) {\n            if(!this.statePlaying)\n                return;\n\n            if(e.keyCode == 40 && this.speed < app.const.SPEED_MAX) {\n                this.speed += app.const.SPEED_STEP;\n                this.play();\n            }\n        },\n        keyUpController: function (e) {\n            if(!this.statePlaying)\n                return;\n\n            var ctrl = e.ctrlKey;\n            if(ctrl) { // develop helpers\n                if(e.keyCode == 81) { // Q\n                    this.endLoop();\n                    if(!this.removeRow)\n                        this.startLoop();\n                }\n                if(e.keyCode == 88) { // X\n                    this.gameOver();\n                }\n            }\n            if(e.keyCode == 40) {\n                this.speed = app.const.SPEED_START;\n                this.play();\n            }\n\n            if(e.keyCode == 37) {\n                this.blockMoveDown = true;\n                this.moveFigure('left');\n                this.blockMoveDown = false;\n            }\n            if(e.keyCode == 39) {\n                this.blockMoveDown = true;\n                this.moveFigure('right');\n                this.blockMoveDown = false;\n            }\n            if(e.keyCode == 38) {\n                if(this.checkRotate()) {\n                    console.log('rotate');\n                }\n            }\n        },\n        gameOver: function () {\n            this.stop();\n            this.statePlaying = null;\n            app.eventDispatcher.trigger('gameover');\n            console.log('gameover');\n        },\n\n        // check func\n        // contain logic for collision\n        // right/left/bottom border\n        // check for gameover\n        checkLeft: function (collection) {\n            var cells = collection.where({left: true}), result = true;\n\n            _.each(cells, function (cell) {\n                var fillCell = this.FC.findWhere({\n                    x: cell.get('x')-this.cellRect,\n                    y: cell.get('y')\n                });\n\n                if(cell.get('x') <= 0 || fillCell) {\n                    result = false;\n                    return true; // break _.each\n                }\n            }.bind(this));\n\n            return result;\n        },\n        checkRight: function (collection) {\n            var cells = collection.where({right: true}), result = true;\n\n            _.each(cells, function (cell) {\n                var fillCell = this.FC.findWhere({\n                    x: cell.get('x')+this.cellRect,\n                    y: cell.get('y')\n                });\n\n                if(cell.get('x')+this.cellRect >= app.const.WIDTH || fillCell) {\n                    result = false;\n                    return true;\n                }\n            }.bind(this));\n\n            return result;\n        },\n        check: function () {\n            var cont = true; // continue?\n\n            // check for bottom border\n            this.CC.find(function (cell) {\n                if(cell.get('y')+this.cellRect == app.const.HEIGHT) {\n                    cont = false;\n                    return cell;\n                }\n            }.bind(this));\n\n            if(!cont) {\n                this.endLoop();\n                if(!this.removeRow)\n                    this.startLoop();\n                return;\n            }\n\n            // check for fill cells\n            this.CC.find(function (cell) {\n                var x = cell.get('x'), y = cell.get('y')+this.cellRect;\n\n                if(this.FC.findWhere({x: x, y: y})) {\n                    cont = false;\n                    return cell;\n                }\n            }.bind(this));\n\n            if(!cont) {\n                this.endLoop();\n                // check for gameover\n                if(this.CC.findWhere({y: 0})) {\n                    this.gameOver();\n                } else if(!this.removeRow) {\n                    this.startLoop();\n                }\n            }\n        },\n        checkFillRow: function () {\n            var group = this.FC.groupBy('y');\n            var row = _.find(group, function (arr) {\n                return arr.length >= app.const.ROW_WIDTH;\n            });\n            if(row) {\n                // TODO: sort wrong\n                row = _.sortBy(row, 'x');\n                this.removeFillRow(row);\n            } else {\n                this.removeRow = false;\n                app.eventDispatcher.trigger('removedFillRow');\n            }\n        },\n        checkRotate: function () {\n            if(this.CC.type == 'C') // cube is figure without rotate\n                return false;\n\n            var tmpCollection = new app.FigureCollection();\n            tmpCollection.add(this.CC.getNewArr());\n            if(this.checkLeft(tmpCollection) && this.checkRight(tmpCollection)) {\n                var no_valid_cell = tmpCollection.find(function (cell) {\n                    if(cell.get('y')+this.cellRect >= app.const.HEIGHT) {\n                        return cell;\n                    }\n                }.bind(this));\n\n                if(no_valid_cell)\n                    return;\n\n                this.CC.rotateSuccess();\n                tmpCollection.setCustom(this.CC.getCustom());\n                this.CC = tmpCollection;\n            }\n        },\n\n        // LOOP\n        startLoop: function () {\n            // var rand = app.classes.helper.getRandomInt(0, 4);\n            this.CC.createFigure(0);\n            this.play();\n        },\n        endLoop: function () {\n            this.CC.each(function (cell) {\n                this.FC.add(cell);\n            }.bind(this));\n            this.checkFillRow();\n        },\n        moveFigure: function (direct) {\n            if(direct == 'left') {\n                if(this.checkLeft(this.CC)) {\n                    this.CC.each(function (cell) {\n                        cell.set('x', cell.get('x')-this.cellRect);\n                    }.bind(this));\n                } else\n                    this.blockMoveDown = false; // unblock move down\n            } else if(direct == 'right') {\n                if(this.checkRight(this.CC)) {\n                    this.CC.each(function (cell) {\n                        cell.set('x', cell.get('x')+this.cellRect);\n                    }.bind(this));\n                } else\n                    this.blockMoveDown = false;\n            }\n            else if(!this.blockMoveDown) {\n                this.CC.each(function (cell) {\n                    cell.set('y', cell.get('y')+this.cellRect);\n                }.bind(this));\n            }\n        },\n        play: function () {\n            if(this.playId)\n                this.stop();\n            this.playId = setInterval(this.render.bind(this), 1000 / this.speed);\n            this.statePlaying = 'play'\n        },\n        stop: function () {\n            clearInterval(this.playId);\n        },\n\n        // Render func\n        draw: function () {\n            this.clear();\n            this.drawFigures();\n        },\n        drawFigures: function () {\n            this.CC.each(this.drawCell, this);\n            this.FC.each(this.drawCell, this);\n        },\n        drawCell: function (cell) {\n            var x = cell.get('x'),\n                y = cell.get('y');\n\n            this.ctx.strokeRect(x, y, this.cellRect-0.5, this.cellRect-0.5);\n            this.ctx.fillRect(x, y, this.cellRect-2, this.cellRect-2);\n        },\n        removeFillRow: function (row) {\n            this.removeRow = true;\n            var y = row[0].get('y');\n            var interval = setInterval(function () {\n                this.clear();\n                if(!row.length) {\n                    clearInterval(interval);\n                    this.FC.each(function (cell) {\n                        if(cell.get('y')<y)\n                            cell.set('y', cell.get('y')+this.cellRect);\n                    }.bind(this));\n                    this.FC.each(this.drawCell, this);\n                    this.checkFillRow();\n                    return;\n                }\n\n                this.FC.remove(row[row.length-1]);\n                this.FC.each(this.drawCell, this);\n                row.pop();\n            }.bind(this), app.const.REMOVE_CELL_ANIMATION_TIME);\n            this.stop();\n        },\n        clear: function () {\n            this.ctx.clearRect(0,0, app.const.WIDTH, app.const.HEIGHT);\n        }\n    });\n})();","var app = app || {};\n\n(function () {\n    \"use strict\";\n    var Page = Backbone.View.extend({\n        el: '#page',\n\n        initialize: function () {\n            app.views = {};\n            app.models = {};\n            app.collections = {};\n            app.eventDispatcher = _.extend({}, Backbone.Events );\n\n            app.views.canvas = new app.CanvasView();\n\n            this.startPlay();\n        },\n        startPlay: function () {\n            app.eventDispatcher.trigger('startPlay');\n        }\n    });\n\n    $(document).ready(function () {\n        app.page = new Page();\n    });\n})();"]}